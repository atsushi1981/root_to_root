import tkinter as tk
from tkinter import scrolledtext, messagebox
import random
import json
import os
from datetime import datetime

class ChatbotGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("å­¦ç¿’å‹ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ")
        self.root.geometry("700x800")

        # å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
        self.learning_data_file = "chatbot_learning_data.json"
        
        # å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        self.load_learning_data()

        # ãƒãƒ£ãƒƒãƒˆå±¥æ­´è¡¨ç¤ºã‚¨ãƒªã‚¢
        self.chat_history = scrolledtext.ScrolledText(root, wrap=tk.WORD, width=70, height=30)
        self.chat_history.pack(padx=10, pady=10)

        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã‚¨ãƒªã‚¢
        self.message_entry = tk.Entry(root, width=50)
        self.message_entry.pack(padx=10, pady=5)

        # é€ä¿¡ãƒœã‚¿ãƒ³
        self.send_button = tk.Button(root, text="é€ä¿¡", command=self.send_message)
        self.send_button.pack(pady=5)
        
        # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³
        self.feedback_frame = tk.Frame(root)
        self.feedback_frame.pack(pady=5)
        
        self.good_button = tk.Button(self.feedback_frame, text="ğŸ‘ è‰¯ã„", command=lambda: self.give_feedback("good"))
        self.good_button.pack(side=tk.LEFT, padx=5)
        
        self.bad_button = tk.Button(self.feedback_frame, text="ğŸ‘ æ‚ªã„", command=lambda: self.give_feedback("bad"))
        self.bad_button.pack(side=tk.LEFT, padx=5)
        
        # å­¦ç¿’ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒœã‚¿ãƒ³
        self.show_data_button = tk.Button(root, text="å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º", command=self.show_learning_data)
        self.show_data_button.pack(pady=5)
        
        # ç¾åœ¨ã®ä¼šè©±å±¥æ­´
        self.current_conversation = []
        
        # æœ€å¾Œã®å¿œç­”
        self.last_response = None
        
        # åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        self.chat_history.insert(tk.END, "ãƒœãƒƒãƒˆ: ã“ã‚“ã«ã¡ã¯ï¼ç§ã¯å­¦ç¿’å‹ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚ä¼šè©±ã‚’æ¥½ã—ã¿ã¾ã—ã‚‡ã†ï¼\n\n")
        
    def load_learning_data(self):
        """å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€"""
        if os.path.exists(self.learning_data_file):
            try:
                with open(self.learning_data_file, 'r', encoding='utf-8') as f:
                    self.learning_data = json.load(f)
            except:
                self.learning_data = self.get_default_learning_data()
        else:
            self.learning_data = self.get_default_learning_data()
            
    def get_default_learning_data(self):
        """ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™"""
        return {
            "responses": {
                "ã“ã‚“ã«ã¡ã¯": ["ã“ã‚“ã«ã¡ã¯ï¼", "ã‚„ã‚ï¼", "ã“ã‚“ã«ã¡ã¯ã€ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"],
                "å…ƒæ°—": ["å…ƒæ°—ã§ã™ï¼", "ã¨ã¦ã‚‚å…ƒæ°—ã§ã™ï¼", "å…ƒæ°—ã„ã£ã±ã„ã§ã™ï¼"],
                "ã•ã‚ˆã†ãªã‚‰": ["ã•ã‚ˆã†ãªã‚‰ï¼", "ã¾ãŸä¼šã„ã¾ã—ã‚‡ã†ï¼", "è‰¯ã„ä¸€æ—¥ã‚’ï¼"],
                "åå‰": ["ç§ã¯å­¦ç¿’å‹ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚", "ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¨ç”³ã—ã¾ã™ã€‚", "ãƒœãƒƒãƒˆã§ã™ã€‚ã‚ˆã‚ã—ãï¼"],
                "å¤©æ°—": ["ä»Šæ—¥ã¯ã„ã„å¤©æ°—ã§ã™ã­ã€‚", "å¤©æ°—ã®è©±é¡ŒãŒå¥½ãã§ã™ã€‚", "æ™´ã‚Œã®æ—¥ãŒå¥½ãã§ã™ã€‚"],
                "æ™‚é–“": ["ç¾åœ¨ã®æ™‚é–“ã‚’æ•™ãˆã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ãŒã€ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"],
                "ã‚ã‚ŠãŒã¨ã†": ["ã©ã†ã„ãŸã—ã¾ã—ã¦ï¼", "ãŠå½¹ã«ç«‹ã¦ã¦å¬‰ã—ã„ã§ã™ï¼", "æ°—è»½ã«è³ªå•ã—ã¦ãã ã•ã„ã­ï¼"],
                "è¶£å‘³": ["ä¼šè©±ã™ã‚‹ã“ã¨ãŒå¥½ãã§ã™ã€‚", "è³ªå•ã«ç­”ãˆã‚‹ã“ã¨ãŒè¶£å‘³ã§ã™ã€‚", "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨è©±ã™ã“ã¨ãŒå¥½ãã§ã™ã€‚"],
                "å¥½ã": ["ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼", "ç§ã‚‚ã‚ãªãŸã®ã“ã¨ãŒå¥½ãã§ã™ï¼", "å¬‰ã—ã„ã§ã™ï¼"],
                "å«Œã„": ["ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚æ”¹å–„ã§ãã‚‹ã“ã¨ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚", "æ®‹å¿µã§ã™ã€‚ä½•ã‹å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ", "ã”ä¸æº€ãŒã‚ã‚Œã°ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚"]
            },
            "default_responses": [
                "ã™ã¿ã¾ã›ã‚“ã€ã‚ˆãåˆ†ã‹ã‚Šã¾ã›ã‚“ã€‚", 
                "ã‚‚ã†å°‘ã—å…·ä½“çš„ã«æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ", 
                "ãã®è³ªå•ã«ã¯ç­”ãˆã‚‰ã‚Œã¾ã›ã‚“ã€‚", 
                "åˆ¥ã®è³ªå•ã‚’ã—ã¦ã¿ã¦ãã ã•ã„ã€‚"
            ],
            "conversation_history": [],
            "user_feedback": {
                "good": {},
                "bad": {}
            },
            "learned_patterns": {}
        }
        
    def save_learning_data(self):
        """å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹"""
        with open(self.learning_data_file, 'w', encoding='utf-8') as f:
            json.dump(self.learning_data, f, ensure_ascii=False, indent=2)

    def send_message(self):
        user_message = self.message_entry.get()
        if user_message.strip() == "":
            return

        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        self.chat_history.insert(tk.END, f"ã‚ãªãŸ: {user_message}\n")
        self.message_entry.delete(0, tk.END)

        # ä¼šè©±å±¥æ­´ã«è¿½åŠ 
        self.current_conversation.append({"role": "user", "content": user_message})
        
        # å¿œç­”ã‚’ç”Ÿæˆ
        ai_message = self.get_ai_response(user_message)
        self.update_chat_history(ai_message)
        
        # ä¼šè©±å±¥æ­´ã«è¿½åŠ 
        self.current_conversation.append({"role": "bot", "content": ai_message})
        
        # ä¼šè©±å±¥æ­´ã‚’ä¿å­˜
        self.learning_data["conversation_history"].append({
            "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "conversation": self.current_conversation.copy()
        })
        
        # å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        self.save_learning_data()

    def get_ai_response(self, user_message):
        # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦å¿œç­”ã‚’é¸æŠ
        for keyword, responses in self.learning_data["responses"].items():
            if keyword in user_message:
                self.last_response = random.choice(responses)
                return self.last_response
        
        # å­¦ç¿’ã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
        for pattern, responses in self.learning_data["learned_patterns"].items():
            if pattern in user_message:
                self.last_response = random.choice(responses)
                return self.last_response
        
        # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¿œç­”
        self.last_response = random.choice(self.learning_data["default_responses"])
        return self.last_response

    def update_chat_history(self, ai_message):
        self.chat_history.insert(tk.END, f"ãƒœãƒƒãƒˆ: {ai_message}\n\n")
        self.chat_history.see(tk.END)
        
    def give_feedback(self, feedback_type):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å‡¦ç†ã™ã‚‹"""
        if not self.last_response:
            messagebox.showinfo("ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯", "ã¾ã å¿œç­”ãŒãªã„ãŸã‚ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã€‚")
            return
            
        # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¨˜éŒ²
        if feedback_type == "good":
            if self.last_response not in self.learning_data["user_feedback"]["good"]:
                self.learning_data["user_feedback"]["good"][self.last_response] = 1
            else:
                self.learning_data["user_feedback"]["good"][self.last_response] += 1
                
            # è‰¯ã„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘ãŸå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å­¦ç¿’
            if self.current_conversation and self.current_conversation[-2]["role"] == "user":
                user_message = self.current_conversation[-2]["content"]
                self.learn_from_conversation(user_message, self.last_response)
                
            messagebox.showinfo("ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯", "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã“ã®å¿œç­”ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ç¿’ã—ã¾ã™ã€‚")
            
        elif feedback_type == "bad":
            if self.last_response not in self.learning_data["user_feedback"]["bad"]:
                self.learning_data["user_feedback"]["bad"][self.last_response] = 1
            else:
                self.learning_data["user_feedback"]["bad"][self.last_response] += 1
                
            messagebox.showinfo("ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯", "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚ˆã‚Šè‰¯ã„å¿œç­”ã‚’å¿ƒãŒã‘ã¾ã™ã€‚")
            
        # å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        self.save_learning_data()
        
    def learn_from_conversation(self, user_message, bot_response):
        """ä¼šè©±ã‹ã‚‰å­¦ç¿’ã™ã‚‹"""
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºï¼ˆå˜ç´”ãªæ–¹æ³•ï¼‰
        words = user_message.split()
        for word in words:
            if len(word) > 1:  # 1æ–‡å­—ã®å˜èªã¯ç„¡è¦–
                if word not in self.learning_data["learned_patterns"]:
                    self.learning_data["learned_patterns"][word] = []
                if bot_response not in self.learning_data["learned_patterns"][word]:
                    self.learning_data["learned_patterns"][word].append(bot_response)
                    
    def show_learning_data(self):
        """å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹"""
        data_window = tk.Toplevel(self.root)
        data_window.title("å­¦ç¿’ãƒ‡ãƒ¼ã‚¿")
        data_window.geometry("600x500")
        
        data_text = scrolledtext.ScrolledText(data_window, wrap=tk.WORD, width=70, height=30)
        data_text.pack(padx=10, pady=10)
        
        # å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤º
        data_text.insert(tk.END, "=== å­¦ç¿’ã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ ===\n")
        for pattern, responses in self.learning_data["learned_patterns"].items():
            data_text.insert(tk.END, f"ãƒ‘ã‚¿ãƒ¼ãƒ³: {pattern}\n")
            data_text.insert(tk.END, f"å¿œç­”: {', '.join(responses)}\n\n")
            
        data_text.insert(tk.END, "=== è‰¯ã„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ ===\n")
        for response, count in self.learning_data["user_feedback"]["good"].items():
            data_text.insert(tk.END, f"å¿œç­”: {response} (è©•ä¾¡: {count}å›)\n")
            
        data_text.insert(tk.END, "\n=== æ‚ªã„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ ===\n")
        for response, count in self.learning_data["user_feedback"]["bad"].items():
            data_text.insert(tk.END, f"å¿œç­”: {response} (è©•ä¾¡: {count}å›)\n")
            
        data_text.config(state=tk.DISABLED)

def main():
    root = tk.Tk()
    app = ChatbotGUI(root)
    root.mainloop()

if __name__ == "__main__":
    main()
